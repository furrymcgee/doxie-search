From 699aef3ba81c2beed3c113a485f2858c5a82c3a0 Mon Sep 17 00:00:00 2001
From: furrymcgee <furrymcgee@lippydanger.jumpingcrab.com>
Date: Wed, 14 Aug 2019 20:41:08 +0200
Subject: [PATCH 2/2] i686-pc-cygwin

---
 Makefile.am         |  2 +-
 configure.ac        | 12 ++++++++++++
 libfakeroot.c       |  2 ++
 scripts/Makefile.am |  2 ++
 scripts/fakeroot.in |  4 ++--
 5 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 6d6f07f..e616c83 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -9,7 +9,7 @@ libmacosx_la_SOURCES = libfakeroot_inode64.c libfakeroot_unix2003.c patchattr.h
 
 lib_LTLIBRARIES=libfakeroot.la
 libfakeroot_la_SOURCES=libfakeroot.c statconv/glibc/linux/alpha/stats.h wrapdef.h  wrapstruct.h communicate.h
-libfakeroot_la_LDFLAGS=-release 0
+libfakeroot_la_LDFLAGS="-release $(DLRELEASE) $(EXTRA_LDFLAGS)"
 if MACOSX
 libfakeroot_la_DEPENDENCIES=wrapdef.h wrapstruct.h libcommunicate.la libmacosx.la $(LTLIBOBJS)
 libfakeroot_la_LIBADD = libcommunicate.la libmacosx.la $(LTLIBOBJS)
diff --git a/configure.ac b/configure.ac
index af765f9..04ab529 100644
--- a/configure.ac
+++ b/configure.ac
@@ -376,7 +376,10 @@ else
 fi
 
 dnl This should really be done intelligently.
+DLPREFIX="lib"
+DLRELEASE=0
 DLSUFFIX=".so"
+EXTRA_LDFLAGS=""
 LDLIBPATHVAR="LD_LIBRARY_PATH"
 LDPRELOADVAR="LD_PRELOAD"
 LDPRELOADABS=0
@@ -385,6 +388,12 @@ case $target_cpu:$target_os in
 	(alpha*:linux*|ia64*:linux*)
 		libcpath="/lib/libc.so.6.1"
 		;;
+	(*:cygwin*)
+		DLPREFIX="cyg"
+		DLSUFFIX=".dll"
+		EXTRA_LDFLAGS="-no-undefined"
+		LDPRELOADABS=1
+		;;
 	(*:linux*)
 	        libcpath="/lib/libc.so.6"
 		;;
@@ -429,7 +438,10 @@ case $target_cpu:$target_os in
 esac
 
 AC_DEFINE_UNQUOTED([LIBCPATH], "$libcpath", [path to libc shared object])
+AC_SUBST(DLPREFIX)
+AC_SUBST(DLRELEASE)
 AC_SUBST(DLSUFFIX)
+AC_SUBST(EXTRA_LDFLAGS)
 AC_SUBST(LDLIBPATHVAR)
 AC_SUBST(LDPRELOADVAR)
 AC_SUBST(LDPRELOADABS)
diff --git a/libfakeroot.c b/libfakeroot.c
index f867758..f186087 100644
--- a/libfakeroot.c
+++ b/libfakeroot.c
@@ -81,12 +81,14 @@
 #define SEND_STAT64(a,b,c) send_stat64(a,b,c)
 #define SEND_GET_STAT(a,b) send_get_stat(a,b)
 #define SEND_GET_STAT64(a,b) send_get_stat64(a,b)
+#define SEND_GET_XATTR(a,b,c) send_get_xattr(a,b,c)
 #define SEND_GET_XATTR64(a,b,c) send_get_xattr64(a,b,c)
 #else
 #define SEND_STAT(a,b,c) send_stat(a,b)
 #define SEND_STAT64(a,b,c) send_stat64(a,b)
 #define SEND_GET_STAT(a,b) send_get_stat(a)
 #define SEND_GET_STAT64(a,b) send_get_stat64(a)
+#define SEND_GET_XATTR(a,b,c) send_get_xattr(a,b)
 #define SEND_GET_XATTR64(a,b,c) send_get_xattr64(a,b)
 #endif
 
diff --git a/scripts/Makefile.am b/scripts/Makefile.am
index cd4065b..273327e 100644
--- a/scripts/Makefile.am
+++ b/scripts/Makefile.am
@@ -20,6 +20,8 @@ do_subst = sed -e 's,[@]prefix[@],$(prefix),g' \
 	   -e 's,[@]signal[@],$(signal),g' \
 	   -e 's,[@]SHELL[@],$(SHELL),g' \
 	   -e 's,[@]VERSION[@],$(VERSION),g' \
+	   -e 's,[@]DLRELEASE[@],$(DLRELEASE),g' \
+	   -e 's,[@]DLPREFIX[@],$(DLPREFIX),g' \
 	   -e 's,[@]DLSUFFIX[@],$(DLSUFFIX),g' \
 	   -e 's,[@]LDLIBPATHVAR[@],$(LDLIBPATHVAR),g' \
 	   -e 's,[@]LDPRELOADVAR[@],$(LDPRELOADVAR),g' \
diff --git a/scripts/fakeroot.in b/scripts/fakeroot.in
index 88ff313..7df2828 100755
--- a/scripts/fakeroot.in
+++ b/scripts/fakeroot.in
@@ -34,8 +34,8 @@ FAKEROOT_PREFIX=@prefix@
 FAKEROOT_BINDIR=@bindir@
 
 USEABSLIBPATH=@LDPRELOADABS@
-LIB=lib@fakeroot_transformed@@DLSUFFIX@
-PATHS=@libdir@:${FAKEROOT_PREFIX}/lib64/libfakeroot:${FAKEROOT_PREFIX}/lib32/libfakeroot
+LIB=@DLPREFIX@@fakeroot_transformed@-@DLRELEASE@@DLSUFFIX@
+PATHS=@libdir@:${FAKEROOT_BINDIR}:${FAKEROOT_PREFIX}/lib64/libfakeroot:${FAKEROOT_PREFIX}/lib32/libfakeroot
 FAKED=${FAKEROOT_BINDIR}/@faked_transformed@
 
 FAKED_MODE="unknown-is-root"
-- 
2.23.0.rc1

