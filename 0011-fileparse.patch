From 5df1a4ff03d3a2a4bb98b3e45373f0813c33930d Mon Sep 17 00:00:00 2001
From: furrymcgee <furrymcgee@lippydanger.jumpingcrab.com>
Date: Thu, 1 Aug 2019 12:13:40 +0200
Subject: [PATCH 11/15] fileparse

---
 perl/Debian/Dwww/Common.pm |  4 +++-
 scripts/dwww.cgi           | 11 +++++++----
 2 files changed, 10 insertions(+), 5 deletions(-)

diff --git a/perl/Debian/Dwww/Common.pm b/perl/Debian/Dwww/Common.pm
index 3fe9b6d..3681819 100644
--- a/perl/Debian/Dwww/Common.pm
+++ b/perl/Debian/Dwww/Common.pm
@@ -7,6 +7,7 @@ package Debian::Dwww::Common;
 use Exporter();
 use strict;
 
+use File::Basename qw(fileparse);
 use Debian::Dwww::Utils;
 use vars qw(@ISA @EXPORT);
 @ISA = qw(Exporter);
@@ -61,7 +62,8 @@ sub GetURL{ # {{{
     if ($href{$format_name} =~ /#FILE#/) {
         return $` . $format_url . $';
     } else {
-        return $href{$format_name} . $format_url;
+        local @_ = fileparse($format_url, keys %href);
+        return join '/', "file://///samba/share", $_[2], $_[0] . $_[2] . "\n\n"
     }
 
 
diff --git a/scripts/dwww.cgi b/scripts/dwww.cgi
index b314c6c..b4fa99f 100755
--- a/scripts/dwww.cgi
+++ b/scripts/dwww.cgi
@@ -8,6 +8,7 @@
 #
 # $Id: dwww.cgi 547 2011-01-15 15:29:55Z robert $
 #
+use Debian::Dwww::Common;
 
 $doc2html       = '/usr/sbin/dwww-convert'; # Document-to-HTML converter
 $search2html    = '/usr/sbin/dwww-find';    # Search and output results as HTML
@@ -77,13 +78,15 @@ if ($search == $TRUE) {
     &error($TRUE, "Couldn't search for @searchstring! ($!)");
 }
 
-elsif (($type eq "") or ($location eq "")) {
+elsif (not $type) {
+    print "Location: " . GetURL(undef, $location);
+}
+
+elsif (not $location) {
     my $port     = $ENV{'SERVER_PORT'} ? ':' . $ENV{'SERVER_PORT'} : '';
     my $protocol = ($ENV{'HTTPS'} and $ENV{'HTTPS'} eq "on") ? "https" : "http";
 
-
-    &RedirectToURL("/cgi-bin/dwww" . &URLEncode($orig_file) . "?type=" . &URLEncode($type));
-
+    print "Location: $protocol://$ENV{'SERVER_NAME'}$port/dwww/\n\n";
 }
 
 else {
-- 
2.23.0.rc1

